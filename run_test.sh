#!/bin/bash

# ============================================================================
# СКРИПТ КОМПИЛЯЦИИ И СИМУЛЯЦИИ VERILOG С ПОДТВЕРЖДЕНИЕМ
# ============================================================================

echo "=== НАЧАЛО КОМПИЛЯЦИИ ==="

# Компиляция со всеми предупреждениями и строгими проверками
iverilog -Wall -Wno-timescale -g2012 -o robot_test \
    robot_cpu.v robot_tb.v chip_74hc.v 2>&1 | tee compile.log

# Сохраняем код возврата компилятора
COMPILE_RESULT=$?

echo "=== РЕЗУЛЬТАТ КОМПИЛЯЦИИ (код: $COMPILE_RESULT) ==="

# Анализ лога компиляции
if [ -f "compile.log" ]; then
       
    read -p "Продолжить выполнение симуляции? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Выполнение прервано пользователем"
        exit 1
    fi
    echo "Продолжаем выполнение..."
fi

# Запуск симуляции только если компиляция успешна ИЛИ пользователь подтвердил
if [ $COMPILE_RESULT -eq 0 ]; then
    echo "=== ЗАПУЩЕНА СИМУЛЯЦИЯ ==="
    vvp robot_test > simulation.log 2>&1
    SIMULATION_RESULT=$?
    echo "=== РЕЗУЛЬТАТ СИМУЛЯЦИИ (код: $SIMULATION_RESULT) ==="
else
    echo "!!! КОМПИЛЯЦИЯ ПРОВАЛЕНА - СИМУЛЯЦИЯ НЕ ЗАПУЩЕНА !!!"
    exit 1
fi